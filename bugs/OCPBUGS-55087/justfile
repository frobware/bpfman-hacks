#!/usr/bin/env just --justfile

# Default catalog image reference
image := ""

# Default target that runs when just is invoked without arguments
default:
    @just --list
    @echo "\nIMPORTANT: An image reference is REQUIRED for most commands."
    @echo "Example usage: just install quay.io/redhat-user-workloads/ocp-bpfman-tenant/ocp-bpfman-operator-catalog-ocp4-19@sha256:DIGEST"
    @echo "\nTo see example image references that have been used previously, check the image-dates.md file."

# Create the bpfman namespace with monitoring enabled
create-namespace:
    oc apply -f manifests/namespace.yaml

# Apply the ImageDigestMirrorSet for image mirroring
apply-idms:
    oc apply -f manifests/bpfman-idms.yaml


# Create or update the CatalogSource with the specified image
create-catalogsource image_ref:
    #!/usr/bin/env bash
    if [ -z "{{image_ref}}" ]; then
      echo "ERROR: No image specified. You must provide an image reference."
      echo "Example: just create-catalogsource quay.io/redhat-user-workloads/ocp-bpfman-tenant/ocp-bpfman-operator-catalog-ocp4-19@sha256:DIGEST"
      exit 1
    fi

    # Use latest-catalog-image tool to get metadata
    metadata_json=""
    if [[ -x "./latest-catalog-image" ]]; then
        metadata_json=$(./latest-catalog-image -image "{{image_ref}}" -output json 2>/dev/null || true)
    fi

    # Extract metadata from JSON
    identifier=""
    short_id=""
    catalog_type="catalog"
    ocp_version=""

    if [[ -n "${metadata_json}" ]] && echo "${metadata_json}" | jq -e . >/dev/null 2>&1; then
        # Valid JSON - use jq to parse metadata
        catalog_type=$(echo "${metadata_json}" | jq -r '.catalog // "catalog"')
        ocp_version=$(echo "${metadata_json}" | jq -r '.version // ""')

        # Always use digest for identifier
        digest=$(echo "${metadata_json}" | jq -r '.digest // ""')
        if [[ "${digest}" =~ ^sha256:([a-f0-9]{8}) ]]; then
            short_id="${BASH_REMATCH[1]}"
        fi
    fi

    # Fallback: parse digest from image ref if tool failed
    if [[ -z "${short_id}" ]]; then
        if [[ "{{image_ref}}" =~ @sha256:([a-f0-9]{8})[a-f0-9]* ]]; then
            # Image digest
            short_id="${BASH_REMATCH[1]}"
        else
            # If no digest in ref and tool failed, we can't get the digest
            echo "Warning: Could not extract digest for unique identifier. Using default name."
        fi
    fi

    # Extract catalog type if not already set
    if [[ "${catalog_type}" == "catalog" ]] || [[ -z "${catalog_type}" ]]; then
        if [[ "{{image_ref}}" =~ /(catalog-[^/@:]+)[/@:] ]]; then
            catalog_type="${BASH_REMATCH[1]}"
        fi
    fi

    # Set identifier if we have a short ID
    if [[ -n "${short_id}" ]]; then
        identifier="-${short_id}"
    fi

    # Create catalog name and display name
    catalog_name="fbc-bpfman-catalogsource${identifier}"

    # Build display name
    if [[ -n "${ocp_version}" ]]; then
        display_name="Bpfman ${catalog_type} v${ocp_version}${identifier}"
    else
        # Display catalog-type more nicely
        display_catalog="${catalog_type}"
        if [[ "${catalog_type}" == "catalog-ystream" ]]; then
            display_catalog="Y-stream"
        elif [[ "${catalog_type}" == "catalog-zstream" ]]; then
            display_catalog="Z-stream"
        fi
        display_name="Bpfman ${display_catalog}${identifier}"
    fi

    # Copy the template and update name, display name, and image
    cp manifests/bpfman-catalogsource.yaml /tmp/bpfman-catalogsource-dev.yaml
    sed -i "s|name: fbc-bpfman-catalogsource|name: ${catalog_name}|" /tmp/bpfman-catalogsource-dev.yaml
    sed -i "s|displayName: .*|displayName: '${display_name}'|" /tmp/bpfman-catalogsource-dev.yaml
    sed -i "s|image: .*|image: {{image_ref}}|" /tmp/bpfman-catalogsource-dev.yaml

    # Apply the modified manifest
    oc apply -f /tmp/bpfman-catalogsource-dev.yaml
    echo "Created CatalogSource: ${catalog_name}"
    echo "Display Name: ${display_name}"

# Create the OperatorGroup
create-operatorgroup:
    oc apply -f manifests/operator-group.yaml

# Create the Subscription to install the operator
create-subscription:
    #!/usr/bin/env bash
    # Get the most recently created catalogsource that matches our pattern
    catalog_name=$(oc get catalogsource -n openshift-marketplace -o json | \
                   jq -r '.items[] | select(.metadata.name | startswith("fbc-bpfman-catalogsource")) | .metadata.name' | tail -n1)

    if [ -z "$catalog_name" ]; then
        echo "ERROR: No bpfman catalogsource found in openshift-marketplace"
        exit 1
    fi

    # Create subscription with the correct catalog source
    cp manifests/subscription.yaml /tmp/subscription-dev.yaml
    sed -i "s|source: fbc-bpfman-catalogsource|source: ${catalog_name}|" /tmp/subscription-dev.yaml
    oc apply -f /tmp/subscription-dev.yaml
    echo "Created subscription using CatalogSource: ${catalog_name}"

# Check the installation status
check-status:
    oc get csv -n bpfman
    @echo
    oc get pods -n bpfman

# Delete everything (cleanup)
cleanup:
    #!/usr/bin/env bash
    # Check if namespace exists before attempting operations within it
    if oc get namespace bpfman >/dev/null 2>&1; then
        oc delete subscription bpfman-operator -n bpfman --ignore-not-found
        oc patch configmap bpfman-config -n bpfman --type=merge -p '{"metadata":{"finalizers":[]}}' 2>/dev/null || true
        oc patch daemonset bpfman-daemon -n bpfman --type=merge -p '{"metadata":{"finalizers":[]}}' 2>/dev/null || true
        oc delete operatorgroup bpfman -n bpfman --ignore-not-found
        oc delete cm bpfman-config -n bpfman --ignore-not-found
        oc wait --for=delete configmap/bpfman-config -n bpfman --timeout=10s 2>/dev/null || true
        oc delete project bpfman --ignore-not-found
    else
        echo "Namespace bpfman not found, skipping namespace-specific cleanup"
    fi

    # These operations don't depend on the namespace
    # Delete all catalogsources that match our pattern (including dev variants)
    oc get catalogsource -n openshift-marketplace -o name | grep "catalogsource.operators.coreos.com/fbc-bpfman-catalogsource" | xargs -r oc delete -n openshift-marketplace
    oc delete -f manifests/bpfman-idms.yaml --ignore-not-found

# Install bpfman operator in one step (catalog source only approach)
install image_ref:
    #!/usr/bin/env bash
    if [ -z "{{image_ref}}" ]; then
      echo "ERROR: No image specified. You must provide an image reference."
      echo "Example: just install quay.io/redhat-user-workloads/ocp-bpfman-tenant/ocp-bpfman-operator-catalog-ocp4-19@sha256:DIGEST"
      exit 1
    fi
    just create-namespace
    just apply-idms
    just create-catalogsource {{image_ref}}
    just create-operatorgroup
    just create-subscription
    echo "Installation complete. Run 'just check-status' to monitor progress (pods may take a few minutes to become ready)."
    echo ""
    echo "For metrics to work correctly with ServiceMonitor, make sure user workload monitoring is enabled:"
    echo "  just enable-monitoring"



# Update the catalog image in the CatalogSource without reinstalling the operator
update-catalog-image image_ref:
    just create-catalogsource {{image_ref}}

# Show information about the provided catalog image
show-image-info image_ref:
    #!/usr/bin/env bash
    if [ -z "{{image_ref}}" ]; then
      echo "No image specified."
      echo "You must provide an image reference."
      echo "Example: just show-image-info quay.io/redhat-user-workloads/ocp-bpfman-tenant/ocp-bpfman-operator-catalog-ocp4-19@sha256:DIGEST"
      exit 0
    fi
    echo "Catalog image reference:"
    echo "  {{image_ref}}"
    echo ""
    echo "Image creation timestamp:"
    podman pull {{image_ref}} &>/dev/null && podman inspect {{image_ref}} | grep Created || echo "  Failed to pull image"

# Enable OpenShift user workload monitoring (required for ServiceMonitors)
enable-monitoring:
    oc apply -f manifests/user-workload-monitoring.yaml
    @echo "User workload monitoring has been enabled. It may take a few minutes for the monitoring components to start."
    @echo "To check if monitoring pods are running:"
    @echo "  oc get pods -n openshift-user-workload-monitoring"
